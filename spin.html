<!DOCTYPE html>
<html>
<head>
  <title>Spin Wheel</title>
  <script type="module" src="firebase.js"></script>
  <style>
    body{
      text-align:center;
      font-family:sans-serif;
      padding:30px;
    }
    #wheel{
      width:300px;
      height:300px;
      border-radius:50%;
      border:10px solid #333;
      margin:auto;
      transition: transform 4s ease-out;
      background: conic-gradient(
        #ff4d4d 0% 40%,
        #4dff4d 40% 70%,
        #4d4dff 70% 85%,
        #ffff4d 85% 95%,
        #ff00ff 95% 100%
      );
    }
    button{
      padding:10px 20px;
      font-size:18px;
      margin-top:20px;
    }
  </style>
</head>
<body>

<h2>Spin & Win</h2>

<div id="wheel"></div>

<button onclick="spinWheel()">SPIN</button>

<h3 id="result"></h3>

<script type="module">
import { db } from "./firebase.js";
import { doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

let spinning = false;

function getReward() {
  const rand = Math.random() * 100;

  if(rand < 40) return "₹50";
  if(rand < 70) return "₹100";
  if(rand < 85) return "₹200";
  if(rand < 95) return "₹500";
  return "₹1000";
}

window.spinWheel = async function() {

  if(spinning) return;
  spinning = true;

  const code = sessionStorage.getItem("validCode");

  if(!code){
    alert("Invalid Access");
    window.location.href = "index.html";
    return;
  }

  const reward = getReward();

  const wheel = document.getElementById("wheel");
  const randomDegree = 3600 + Math.floor(Math.random()*360);
  wheel.style.transform = "rotate(" + randomDegree + "deg)";

  setTimeout(async () => {
    document.getElementById("result").innerText = "You won: " + reward;

    await updateDoc(doc(db,"codes",code),{
      used:true,
      reward:reward
    });

    sessionStorage.removeItem("validCode");

    spinning = false;

  },4000);
}
</script>

</body>
</html>
